openapi: 3.0.3
info:
  title: 使用者行為埋點分析系統 API
  description: POC 等級的後端系統，用於接收與查詢前端送出的使用者行為事件
  version: 1.0.0
servers:
  - url: http://localhost:5000
    description: 開發環境伺服器

paths:
  /events/batch:
    post:
      summary: 批次提交事件
      description: 接受最多 10 筆事件的批次提交，實施 Ingestion Rules 進行驗證
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BatchRequest'
      responses:
        '200':
          description: 部分成功響應，包含接受和拒絕的事件
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchResponse'
      tags:
        - Events

  /events:
    get:
      summary: 查詢所有事件
      description: 使用 key-based cursor 查詢所有公司的事件
      parameters:
        - name: t
          in: query
          description: Cursor 用於分頁，格式為 {timestamp}|{companyId}|{employeeId}|{deviceType}|{deviceId}
          required: false
          schema:
            type: string
        - name: size
          in: query
          description: 每頁事件數量，預設為 100
          required: false
          schema:
            type: integer
            default: 100
      responses:
        '200':
          description: 查詢成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueryResponse'
      tags:
        - Events

  /companies/{companyId}/events:
    get:
      summary: 查詢特定公司的事件
      description: 使用 key-based cursor 查詢特定公司的事件
      parameters:
        - name: companyId
          in: path
          required: true
          description: 公司 ID
          schema:
            type: string
        - name: t
          in: query
          description: Cursor 用於分頁，格式為 {timestamp}|{companyId}|{employeeId}|{deviceType}|{deviceId}
          required: false
          schema:
            type: string
        - name: size
          in: query
          description: 每頁事件數量，預設為 100
          required: false
          schema:
            type: integer
            default: 100
      responses:
        '200':
          description: 查詢成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueryResponse'
      tags:
        - Companies

components:
  schemas:
    Event:
      type: object
      required:
        - productId
        - companyId
        - employeeId
        - sessionId
        - screenId
        - eventType
        - timestamp
        - deviceId
        - eventId
        - metadata
        - deviceInfo
        - flags
      properties:
        productId:
          type: string
          description: 產品唯一標識符
        companyId:
          type: string
          description: 公司唯一標識符（多租戶）
        employeeId:
          type: string
          description: 員工/使用者唯一標識符
        sessionId:
          type: string
          description: 使用者會話唯一標識符
        screenId:
          type: string
          description: 事件發生的畫面標識符
        eventType:
          type: string
          description: 事件類型（如 enter_screen、click、leave_screen）
          enum: [enter_screen, click, leave_screen]
        timestamp:
          type: integer
          format: int64
          description: 事件發生的時間戳（epoch 毫秒）
        deviceId:
          type: string
          description: 裝置唯一標識符
        eventId:
          type: string
          description: 事件唯一標識符（timestamp-CompanyId-EmployeeId-DeviceType-DeviceId 格式）
        metadata:
          $ref: '#/components/schemas/EventMetadata'
        deviceInfo:
          $ref: '#/components/schemas/DeviceInfo'
        flags:
          $ref: '#/components/schemas/EventFlags'

    EventMetadata:
      type: object
      description: 事件的附加資料
      properties:
        view:
          type: string
          description: enter_screen 事件需要的欄位，標識進入的視圖
          example: "dashboard"
        componentId:
          type: string
          description: click 事件需要的欄位，標識被點擊的元件
          example: "submit-button"
        duration:
          type: number
          description: leave_screen 事件需要的欄位，表示停留的持續時間
          example: 12345

    DeviceInfo:
      type: object
      required:
        - deviceType
        - os
      properties:
        deviceType:
          type: string
          description: 裝置類型
          enum: [Android, IOS, Browser]
        os:
          type: string
          description: 作業系統

    EventFlags:
      type: object
      properties:
        unknown_eventType:
          type: boolean
          description: 標示是否為未知的事件類型
        extra_fields:
          type: boolean
          description: 標示是否包含多餘的欄位

    BatchRequest:
      type: object
      required:
        - events
      properties:
        events:
          type: array
          maxItems: 10
          description: 事件陣列，最多 10 筆
          items:
            $ref: '#/components/schemas/Event'

    BatchResponse:
      type: object
      properties:
        accepted:
          type: array
          description: 成功處理的事件
          items:
            type: object
            required:
              - eventId
            properties:
              eventId:
                type: string
                description: 成功處理的事件 ID
        rejected:
          type: array
          description: 被拒絕的事件
          items:
            type: object
            required:
              - eventId
              - error_code
              - message
            properties:
              eventId:
                type: string
                description: 被拒絕的事件 ID
              error_code:
                type: string
                description: 錯誤代碼（全大寫 + 底線格式）
                example: "DUPLICATE_EVENT_ID_IN_BATCH"
              message:
                type: string
                description: 錯誤訊息
                example: "Duplicate eventId in the same batch."

    QueryResponse:
      type: object
      required:
        - events
        - next_cursor
        - size
      properties:
        events:
          type: array
          description: 原始事件陣列（包含 flags）
          items:
            $ref: '#/components/schemas/Event'
        next_cursor:
          type: string
          description: 用於獲取下一頁的 cursor，格式為 {timestamp}|{companyId}|{employeeId}|{deviceType}|{deviceId}
          example: "1768888894123|company123|employee456|Android|device789"
        size:
          type: integer
          description: 返回的事件數量

tags:
  - name: Events
    description: 事件處理與查詢相關 API
  - name: Companies
    description: 公司相關事件查詢 API